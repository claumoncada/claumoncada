-- Sentencias SQL para la creación del Data Warehouse y sus tablas de hechos y dimensiones 
-- Crear la base de datos
CREATE DATABASE DWH_TRANS;
GO

-- Usar la base de datos
USE DWH_TRANS;
GO

-- Tablas de Dimensiones
-- Dimensión: Producto
CREATE TABLE DWH_TRANS.dbo.Dim_Product (
    ProductID INT PRIMARY KEY, -- Llave primaria
    ProductName VARCHAR(255), -- Nombre del producto
    ProductBrand VARCHAR(255), -- Marca del producto
    ProductColor VARCHAR(255), -- Color del producto
    ProductCost DECIMAL(10,2), -- Costo del producto
    ProductPrice DECIMAL(10,2), -- Precio del producto
    SubcategoryName VARCHAR(255), -- Nombre de subcategoría
    CategoryName VARCHAR(255) -- Nombre de categoría
);
GO

-- Insertar datos en la tabla Dim_Product desde las tablas originales
INSERT INTO DWH_TRANS.dbo.Dim_Product (ProductID, ProductName, ProductBrand, ProductColor, ProductCost, ProductPrice, SubcategoryName, CategoryName)
SELECT p.ProductID, p.ProductName, p.ProductBrand, p.ProductColor, p.ProductCost, p.ProductPrice, ps.SubcategoryName, pc.CategoryName
FROM Product p
JOIN ProductSubcategory ps ON p.SubcategoryID = ps.SubcategoryID
JOIN ProductCategory pc ON ps.CategoryID = pc.CategoryID;
GO


-- Dimensión: Cliente
CREATE TABLE DWH_TRANS.dbo.Dim_Customer (
    CustomerID INT PRIMARY KEY, -- Llave primaria
    CustomerGender VARCHAR(10), -- Género del cliente
    CustomerName VARCHAR(255), -- Nombre del cliente
    CustomerDOB DATE, -- Fecha de nacimiento del cliente
    CustomerCity VARCHAR(255), -- Ciudad del cliente
    CustomerState VARCHAR(255), -- Estado del cliente
    CustomerZip VARCHAR(20), -- Código postal del cliente
    CustomerCountry VARCHAR(255), -- País del cliente
    CustomerContinent VARCHAR(255) -- Continente del cliente
);
GO

-- Insertar datos en la tabla Dim_Customer desde las tablas originales
INSERT INTO DWH_TRANS.dbo.Dim_Customer (CustomerID, CustomerGender, CustomerName, CustomerDOB, CustomerCity, CustomerState, CustomerZip, CustomerCountry, CustomerContinent)
SELECT c.CustomerID, c.CustomerGender, c.CustomerName, c.CustomerDOB, cl.CustomerCity, cs.CustomerState, cz.CustomerZip, cc.CustomerCountry, cc.CustomerContinent
FROM Customer c
JOIN CustomerLocation cl ON c.CustomerLocationID = cl.LocationID
JOIN CustomerState cs ON cl.StateID = cs.StateID
JOIN CustomerZipCode cz ON cs.ZipID = cz.ZipID
JOIN CustomerCountry cc ON cz.CountryID = cc.CountryID;
GO

-- Dimensión: Tienda
CREATE TABLE DWH_TRANS.dbo.Dim_Store (
    StoreID INT PRIMARY KEY, -- Llave primaria
    StoreSqMeters INT, -- Tamaño de la tienda en metros cuadrados
    StoreOpenDate DATE, -- Fecha de apertura de la tienda
    StoreCountry VARCHAR(255), -- País de la tienda
    StoreState VARCHAR(255) -- Estado de la tienda
);
GO

-- Insertar datos en la tabla Dim_Store desde las tablas originales
INSERT INTO DWH_TRANS.dbo.Dim_Store (StoreID, StoreSqMeters, StoreOpenDate, StoreCountry, StoreState)
SELECT s.StoreID, s.StoreSqMeters, s.StoreOpenDate, sl.StoreCountry, sl.StoreState
FROM Stores s
JOIN StoreLocation sl ON s.StoreLocationID = sl.StoreLocationID;
GO


--Tabla de Hechos
-- Hechos: Transacciones
CREATE TABLE DWH_TRANS.dbo.Fact_Transactions (
    TransactionID INT PRIMARY KEY, -- Llave primaria
    OrderNumber INT, -- Referencia a la orden
    Quantity INT, -- Cantidad del producto
    ProductID INT, -- Referencia al producto
    StoreID INT, -- Referencia a la tienda
    CustomerID INT, -- Referencia al cliente
    OrderDate DATE, -- Fecha de la orden
    DeliveryDate DATE -- Fecha de entrega
);
GO

-- Insertar datos en la tabla Fact_Transactions desde las tablas originales
INSERT INTO DWH_TRANS.dbo.Fact_Transactions (TransactionID, OrderNumber, Quantity, ProductID, StoreID, CustomerID, OrderDate, DeliveryDate)
SELECT t.TransactionID, t.OrderNumber, t.Quantity, t.ProductID, t.StoreID, o.CustomerID, t.OrderDate, t.DeliveryDate
FROM Transactions t
JOIN Orders o ON t.OrderNumber = o.OrderNumber;
GO